{% extends "global/Page.html" %}
{% load otree static %}
{% load staticfiles otree %}

{{ block title }}
Decision
{{ endblock }}
{{ block content }}
<style>
    th,
    td {
        border: 1px solid black;
        height: 10px;
        text-align: center;
    }
</style>

Round number: {{player.round_number}}
<br>
Group size: {{group_size}}
<br>
Your player ID: {{player.id_in_group}}


<h1>Preference Table</h1>
<table id="orig-pref-table">
    <tr>
        <th>Space</th>
        <th>Term</th>
        <th>Payoff</th>
    </tr>
    {{ for space, term, payoff in preference }}
    <tr>
        <td>{{space}}</td>
        {{ if term == 0}}
        <td>-</td>
        {{ else }}
        <td>+</td>
        {{ endif }}
        <td>{{payoff}}</td>
    </tr>
    {{ endfor }}
</table>

<h1>Decision Sheet</h1>
<table id="pref-table">
    <tr>
        <th>Space ID</th>
        <th>Term</th>
        <th>Payoff</th>
    </tr>
    {{ for space, term, payoff in preference }}
    <tr draggable="true" ondragstart="dragstart()" ondragover="dragover()">
        <td>{{space}}</td>
        {{ if term == 0}}
        <td>-</td>
        {{ else }}
        <td>+</td>
        {{ endif }}
        <td>{{payoff}}</td>
    </tr>
    {{ endfor }}
</table>
<button id="send-pref" onclick="send_preferences()">Send</button>

<script>
    var row;
    function dragstart() {
        row = event.target;
    }
    function dragover() {
        var e = event;
        e.preventDefault();

        let children = Array.from(e.target.parentNode.parentNode.children);
        if (children.indexOf(e.target.parentNode) > children.indexOf(row))
            e.target.parentNode.after(row);
        else
            e.target.parentNode.before(row);
    }

    function send_preferences() {
        const table = document.getElementById("pref-table");
        const rows = table.querySelectorAll("tr");

        const preference = [];
        rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            if (cells.length == 3) {
                var id = parseInt(cells[0].textContent);
                var term = cells[1].textContent == "-" ? 0 : 1;
                var payoff = parseInt(cells[2].textContent);
                preference.push([id, term, payoff]);
            }
        });
        liveSend({
            'preference': preference
        });
    }
</script>

{{ endblock }}
